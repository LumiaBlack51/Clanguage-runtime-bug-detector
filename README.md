# C Safety Scanner

一个基于启发式分析的 C 代码安全扫描工具，用于检测常见的编程错误和安全问题。

## 🚀 功能特性

### 核心检测功能
- **未初始化变量检测**: 检测变量在初始化前被使用的情况
- **野指针检测**: 检测未初始化指针的解引用操作
- **空指针检测**: 检测空指针的解引用操作
- **头文件拼写检查**: 检测非标准头文件名称的拼写错误
- **死循环检测**: 通过模拟循环执行检测潜在的死循环
- **数值范围检查**: 检测赋值时数值是否超出变量类型范围
- **内存泄漏检测**: 检测堆内存分配后未释放的情况
- **printf/scanf格式检查**: 检测格式字符串与参数的不匹配

### 高级特性
- **存储类说明符支持**: 支持 `static`、`const`、`extern` 等存储类说明符的识别
- **函数参数识别**: 正确识别函数参数，避免误报
- **作用域管理**: 支持全局和函数局部作用域的变量管理
- **分段哈希表优化**: 使用分段哈希表优化变量查找性能

## 📦 安装与使用

### 依赖安装
```bash
npm install
```

### 编译
```bash
npm run compile
```

### 基本使用
```bash
# 扫描指定目录
node ./out/cli.js <目录路径>

# 扫描测试用例
npm run scan:buggy    # 扫描错误用例
npm run scan:correct  # 扫描正确用例

# 生成报告
npm run report:buggy
npm run report:correct
```

### VS Code 扩展
```bash
# 打包扩展
npm run vsce:package
```

安装生成的 `.vsix` 文件到 VS Code 中，即可使用图形界面进行扫描。

## 🔍 检测规则详解

### 1. 未初始化变量检测
检测变量在赋值前被使用的情况，包括：
- 局部变量未初始化使用
- 全局变量未初始化使用
- 静态变量未初始化使用

### 2. 野指针和空指针检测
检测指针相关的安全问题：
- 直接解引用: `*ptr`
- 结构体成员访问: `ptr->field`
- 数组访问: `ptr[index]`
- 空指针解引用: `NULL` 或 `0` 指针的解引用

### 3. 死循环检测
通过模拟循环执行检测潜在的死循环：
- 明显死循环: `for(;;)`, `while(1)`, `while(true)`
- 循环条件错误: 循环变量永远不会满足退出条件
- 步长问题: 循环变量步长过大或过小
- 支持 `break`、`return`、`exit()` 检测，避免误报

### 4. 数值范围检查
检测赋值时数值是否超出变量类型范围：
- 支持 `char`, `short`, `int`, `long`, `long long` 等类型
- 支持十六进制(`0x`)和八进制(`0`)数值解析
- 检测声明时初始化和赋值时的范围溢出

### 5. 内存泄漏检测
检测堆内存分配后未释放的情况：
- 支持 `malloc()`, `calloc()`, `realloc()` 的检测
- 跟踪 `free()` 调用
- 在函数结束时检查未释放的内存
- 每个指针最多报告一次，避免重复报告

### 6. 头文件拼写检查
检测非标准头文件名称的拼写错误：
- 支持所有标准 C 库头文件
- 检测拼写错误和可疑的头文件名

### 7. printf/scanf格式检查
检测格式字符串与参数的不匹配：
- 参数数量少于格式化占位数
- 参数数量多于格式化占位数
- scanf 参数缺少地址操作符 `&`

## 🏗️ 技术架构

### 核心方法
- **启发式解析**: 使用基于正则表达式的行级解析，稳定可靠
- **分段哈希表**: 使用4段哈希表优化变量查找性能 (a-f, g-m, n-s, t-z)
- **作用域管理**: 支持全局和函数局部作用域的变量管理

### 数据结构
```typescript
type VariableInfo = {
  name: string;           // 变量名
  typeName: string;       // 类型名（支持存储类说明符）
  isPointer: boolean;     // 是否为指针
  isInitialized: boolean; // 是否已初始化
  isArray?: boolean;      // 是否为数组
  pointerMaybeNull?: boolean; // 指针是否可能为NULL
};
```

### 性能优化
- **分段哈希表**: 将变量名按首字母分为4段，减少哈希冲突
- **正则表达式优化**: 预编译常用正则表达式
- **作用域缓存**: 缓存当前作用域的变量表

## 📊 测试用例

项目包含完整的测试用例集：

### 错误测试用例 (`tests/graphs/buggy/`)
- `bug_0.c`: 基础测试用例
- `bug_45.c`: 野指针和空指针测试
- `bug_46.c`: 内存泄漏测试
- `bug_47.c`: 数值范围检查测试
- `bug_48.c`: 死循环检测测试
- `bug_49.c`: 函数参数测试
- `bug_50.c`: static/const变量测试
- `graph.c`: 图操作函数（含多个BUG）
- `graph.h`: 头文件
- `main.c`: 主程序

### 正确测试用例 (`tests/graphs/correct/`)
- `graph.c`: 正确的图操作
- `graph.h`: 头文件
- `main.c`: 主程序

## 📈 性能指标

当前版本的性能指标：
- **Precision**: 高精度，误报率低
- **Recall**: 中等召回率，有少量漏报
- **F1**: 平衡的精确度和召回率

### 检测能力统计
- **数值范围检查**: ✅ 正常工作
- **内存泄漏检测**: ✅ 正常工作（已优化）
- **野指针检测**: ✅ 正常工作
- **死循环检测**: ✅ 正常工作
- **未初始化变量检测**: ✅ 正常工作
- **头文件拼写检查**: ✅ 正常工作

## 🔧 限制和注意事项

### 当前限制
1. **未实现的检测**:
   - 函数返回值检查
   - 更复杂的控制流分析
   - 跨函数的数据流分析

2. **误报原因**:
   - 按址传递参数的复杂场景识别不完整
   - 函数调用返回值的使用场景
   - 复杂表达式的变量使用检测

3. **漏报原因**:
   - 仅在使用时检测，不在声明时检测
   - 缺少高级控制流分析
   - 缺少跨函数的数据流分析

### 使用建议
1. **结合其他工具**: 建议与编译器警告、静态分析工具结合使用
2. **人工审查**: 对于复杂的代码逻辑，建议进行人工审查
3. **定期更新**: 保持工具的最新版本以获得最佳检测效果

## 📚 文档

- [用户指南](USER_GUIDE.md): 详细的功能说明和使用方法
- [算法文档](docs/ALGORITHM.md): 技术实现细节
- [运行日志](docs/LOGS.md): 测试结果和性能分析
- [项目状态](PROJECT_STATUS.md): 项目当前状态和计划

## 🚀 开发历史

- **v0.0.1**: 基础功能实现
  - 未初始化变量检测
  - 野指针检测
  - 头文件拼写检查
- **v0.0.2**: 功能增强
  - 死循环检测
  - 数值范围检查
  - 内存泄漏检测
  - 优化内存泄漏检测逻辑
- **v0.0.3**: 性能优化
  - 分段哈希表优化
  - 作用域管理改进
  - 存储类说明符支持

## 🤝 贡献

如果您发现 bug 或有改进建议，请：
1. 检查现有的测试用例
2. 创建新的测试用例来重现问题
3. 提交详细的错误报告
4. 提供修复建议

## 📄 许可证

MIT License